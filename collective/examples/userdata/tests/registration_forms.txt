Testing extended registration and add new user forms
====================================================

    >>> browser = self.browser
    >>> browser.open('http://nohost/plone')

    Self-registration is disabled, user does not see 'Register' link.
    >>> 'Register' in browser.contents
    False
    
    Enable self-registration
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Enable self-registration').selected = True
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True

    >>> browser.getLink(url='http://nohost/plone/logout').click()
    >>> 'Log in' in browser.contents
    True
    
    Logged out user should now see the register link.
    >>> 'Register' in browser.contents
    True
    
    >>> browser.getLink('Register').click()
    >>> '@@register' in browser.url
    True

    No mailhost has been set up yet. User should not be able to see the form.
    >>> browser.contents
    '...This site...valid email setup...cannot register at this time...'
    >>> 'User Name' in browser.contents
    False
    
    Check that the form is not displayed when no mailhost is defined and users
    cannot choose their own passwords. 
    >>> 'User Name' in browser.contents
    False
    >>> 'Password' in browser.contents
    False
    >>> 'Confirm password' in browser.contents
    False

    Set up a mailhost...
    >>> self.setMailHost()
    >>> browser.open('http://nohost/plone/@@register')

    The form should now be visible, sans password, since the user still cannot
    set it.
    >>> browser.contents
    '...User Name...First name...Last name...Gender...Birthdate...City...Country...Telephone number...Subscribe to newsletter...Accept terms of use...'
    >>> 'Password' in browser.contents
    False
    >>> 'Confirm password' in browser.contents
    False

    Ensure that fields are being validated
    >>> browser.getControl('Register').click()
    >>> browser.contents
    '...There were errors...User Name...Required input is missing...E-mail...Required input is missing...Gender...Required input is missing...Accept terms of use...Constraint not satisfied...'
    
    Fill out the form. 
    >>> browser.getControl('User Name').value = 'user1'
    >>> browser.getControl('First name').value = 'User'
    >>> browser.getControl('Last name').value = 'One'
    >>> browser.getControl(name='form.gender').value = ['Male']
    >>> browser.getControl(name='form.birthdate-day').value = '10'
    >>> browser.getControl(name='form.birthdate-month').value = ['3']
    >>> browser.getControl(name='form.birthdate-year').value = '1975'
    >>> browser.getControl('City').value = 'New York'
    >>> browser.getControl('Country').value = 'USA'
    >>> browser.getControl('Telephone number').value = '9827384736'
    >>> browser.getControl(name='form.newsletter:list').value = ['selected']
    >>> browser.getControl(name='form.accept:list').value = ['selected']
    >>> browser.getControl('E-mail').value = 'user1@example.com'
    >>> browser.getControl('Register').click()
    >>> 'Failed to create your account' not in browser.contents
    True

    Ensure that the user has, in fact, been added.
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@usergroup-userprefs')
    >>> 'user1' in browser.contents
    True
    
    Disable the mailhost and enable user ability to set their own password.
    >>> self.unsetMailHost()
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Let users select their own passwords').selected = True
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True
    
    >>> browser.getLink(url='http://nohost/plone/logout').click()
    >>> 'Log in' in browser.contents
    True
    
    >>> browser.getLink('Register').click()
    >>> '@@register' in browser.url
    True
    
    Check that password is now displayed
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    
    Fill out the form.
    >>> browser.getControl('User Name').value = 'user2'
    >>> browser.getControl('First name').value = 'User'
    >>> browser.getControl('Last name').value = 'Two'
    >>> browser.getControl(name='form.gender').value = ['Female']
    >>> browser.getControl(name='form.birthdate-day').value = '2'
    >>> browser.getControl(name='form.birthdate-month').value = ['7']
    >>> browser.getControl(name='form.birthdate-year').value = '1982'
    >>> browser.getControl('City').value = 'Paris'
    >>> browser.getControl('Country').value = 'France'
    >>> browser.getControl('Telephone number').value = '7948586869'
    >>> browser.getControl(name='form.accept:list').value = ['selected']
    >>> browser.getControl('E-mail').value = 'user2@example.com'
    >>> browser.getControl('Password').value = 'bigfïsh'
    >>> browser.getControl('Confirm password').value = 'bigfïsh'
    >>> browser.getControl('Register').click()
    >>> browser.contents
    '...Welcome!...You have been registered...'

    Ensure that the user has, in fact, been added.
    >>> browser.open('http://nohost/plone/login_form')
    >>> browser.getControl('Login Name').value = 'admin'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Log in').click()
    >>> browser.open('http://nohost/plone/@@usergroup-userprefs')
    >>> 'user2' in browser.contents
    True
    
    Great! The user-facing form works. Let's try the manager's version...
    >>> browser.open('http://nohost/plone/@@usergroup-userprefs')
    >>> browser.getControl('Add New User').click()
    >>> '@@new-user' in browser.url
    True    

    Check that password and groups are displayed.
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    >>> 'Add to the following groups' in browser.contents
    True

    Also check if extended fields are there.
    >>> browser.contents
    '...User Name...First name...Last name...Gender...Birthdate...City...Country...Telephone number...Subscribe to newsletter...'
    
    And Accept Terms field should not be there.
    >>> 'Accept terms of use' not in browser.contents
    True

    Check that the mail prompt is not displayed, as the mailhost is
    not setup correctly.
    >>> 'Send a confirmation mail with a link to set the password' in browser.contents
    False
    
    Turn off the ability for users to set their own passwords.  We are
    now back to the default settings.
    >>> browser.open('http://nohost/plone/@@security-controlpanel')
    >>> browser.getControl('Let users select their own passwords').selected = False
    >>> browser.getControl('Save').click()
    >>> 'Changes saved' in browser.contents
    True
    
    Most fields are displayed again:
    >>> browser.open('http://nohost/plone/@@new-user')
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    >>> 'Add to the following groups' in browser.contents
    True

    We do not offer the opportunity to send an email though, as the
    mailhost is not set up.
    >>> 'Send a confirmation mail with a link to set the password' in browser.contents
    False

    Fill out the form.
    >>> browser.getControl('User Name').value = 'user3'
    >>> browser.getControl('First name').value = 'User'
    >>> browser.getControl('Last name').value = 'Three'
    >>> browser.getControl(name='form.gender').value = ['Male']
    >>> browser.getControl(name='form.birthdate-day').value = '2'
    >>> browser.getControl(name='form.birthdate-month').value = ['4']
    >>> browser.getControl(name='form.birthdate-year').value = '1978'
    >>> browser.getControl('City').value = 'Oslo'
    >>> browser.getControl('Country').value = 'Norway'
    >>> browser.getControl('Telephone number').value = '8876546374'
    >>> browser.getControl('E-mail').value = 'user3@example.com'
    >>> browser.getControl('Password').value = 'secret'
    >>> browser.getControl('Confirm password').value = 'secret'
    >>> browser.getControl('Register').click()
    >>> '@@usergroup-userprefs' in browser.url
    True

    >>> browser.contents
    '...User added...user3...'

    We can really get the new user.
    >>> browser.getLink('user3').click()

    Set up the mailhost and try again.
    >>> self.setMailHost()
    >>> browser.open('http://nohost/plone/@@new-user')
    >>> 'Password' in browser.contents
    True
    >>> 'Confirm password' in browser.contents
    True
    >>> 'Add to the following groups' in browser.contents
    True

    Check that the mail prompt is displayed correctly now.  Note that
    we never send passwords in the email, only a password reset link.
    >>> 'Send a mail with the password' in browser.contents
    False
    >>> 'Send a confirmation mail with a link to set the password' in browser.contents
    True

    Fill out the form.
    >>> browser.getControl('User Name').value = 'user4'
    >>> browser.getControl('E-mail').value = 'user4@example.com'
    >>> browser.getControl('Reviewers').selected = True

    But, at first, let's try to check form validation a bit. Do not set 'mail me' and 'password' fields.
    
    By Default Mail Me is checked.
    >>> browser.getControl(name='form.mail_me:list').value in (True, ['selected'])
    True
    >>> browser.getControl(name='form.mail_me:list').value = False
    >>> browser.getControl('Register').click()
    >>> browser.contents
    '...You must set a password or choose to send an email...Gender...Required input is missing...'

    As we want to validate emails. The password fields have become optional.
    Also fill in another required field: Gender.
    >>> browser.getControl(name='form.mail_me:list').value = True
    >>> browser.getControl(name='form.gender').value = ['Male']
    >>> browser.getControl('Register').click()
    >>> print browser.url
    http://...@@usergroup-userprefs...
    >>> print browser.contents
    <...User added...user4...

    Check that at least this one error does not show up:
    >>> "Failed to create your account" in browser.contents
    False
    
    Check that the selected group has been applied to the new user.
    >>> browser.getLink('user4').click()
    >>> browser.getLink('Group Memberships').click()
    >>> browser.contents
    '...Current group memberships...
    ...Reviewers...'
